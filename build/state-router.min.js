(function(){var t={}.hasOwnProperty,e=[].slice,r=function(e,r){function n(){this.constructor=e}for(var o in r)t.call(r,o)&&(e[o]=r[o]);return n.prototype=r.prototype,e.prototype=new n,e.__super__=r.prototype,e},n=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};!function(t,e){"function"==typeof define&&define.amd?define(["lodash","jquery","XRegExp","strict-parameters","pub-sub","property-accessors","yess","ize","coffee-concerns"],function(r,n,o,a,s,i){return t.StateRouter=e(t,r,n,o,a,s,i)}):"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t,require("lodash"),require("jquery"),require("XRegExp"),require("strict-parameters"),require("pub-sub"),require("property-accessors"),require("yess"),require("ize"),require("coffee-concerns")):t.StateRouter=e(t,t._,t.$,t.XRegExp,t.StrictParameters,t.PublisherSubscriber,t.PropertyAccessors)}(this,function(o,a,s,i,u,c,p){var h,l,f,d,m,y,g,v,S,b,_,w,R,P,x,C,q,I,E;return E=i.XRegExp||i,S={},function(){var t,e,r,n,o,s;for(o="history linksInterceptor paramHelper pathDecorator patternCompiler stateBuilder dispatcher stateMatcher stateStore",t=function(t){var e,r,n;return r="_"+t,n="load"+t.capitalize(),e=t.classCase(),S[n]=function(){return S[r]||(S[r]=new S[e](a.result(S,t+"Options")))},p.property(S,t,{readonly:!0,get:n})},s=o.split(/\s+/),e=0,r=s.length;r>e;e++)n=s[e],t(n);p.property(S,"states",{readonly:!0,get:"loadStateStore"})}(),w={included:function(t){return t.param("defaults",{as:"_ownDefaults"}),t.property("ownDefaults",function(){return a.isFunction(this._ownDefaults)&&(this._ownDefaults=this._ownDefaults()),a.isObject(this._ownDefaults)||(this._ownDefaults={}),this._ownDefaults}),t.property("defaults",function(){var t,e,r,n,o;for(n=this,r={};n;){if(t=n.ownDefaults)for(e in t)o=t[e],null==r[e]&&(r[e]=o);n=n.base}return r})}},x={extractParams:function(e){var r,n,o,s,i;r=S.paramHelper,n=this.pattern.match(e),s=a.extend({},this.defaults);for(o in n)t.call(n,o)&&(i=n[o],r.refersToRegexMatch(o)||null!=i&&(s[o]=r.refersToQueryString(o)?i:r.decode(o,i)));return s},identityParams:function(e){var r,n,o,s,i;r=S.paramHelper,n=this.pattern.identity(e),s=a.extend({},this.defaults),s.query=this.extractQueryString(e);for(o in n)t.call(n,o)&&(i=n[o],null==i||r.refersToRegexMatch(o)||(s[o]=r.decode(o,i)));return s},extractQueryString:function(t){var e;return null!=(e=E.exec(t,S.patternCompiler.reQueryString))?e.query:void 0}},x.params=x.extractParams,P={included:function(t){return t.param("assembler",{as:"ownRouteAssembler"}),t.param("paramAssembler")},paramAssembler:function(t,e,r,n,o,a){var s,i,u;if(u=null!=(i=null!=t?t[a]:void 0)?i:this.defaults[a],null==u){if(!r)throw"["+S+"] Parameter '"+a+"' is required to assemble "+this.name+" state's route";return""}return s=S.paramHelper,(n||"")+(o?s.encodeSplat(a,u):s.encode(a,u))},assembleRoute:function(t){var e,r,n,o;return o=(null!=(n=this.base)?n.assembleRoute(t):void 0)||"",e=this.assembleOwnRoute(t),o=o?o+(e?"/":"")+e:e,(r=null!=(null!=t?t.query:void 0))&&(o=o+("?"===r[0]?"":"?")+r),o},assembleOwnRoute:function(t){var e,r,n;return(e=this.ownRouteAssembler)?r=e.call(this,a.extend({},this.ownDefaults,t),this):(n=this.pattern.ownPath,r=S.pathDecorator.replaceParams(n,a.bind(this.paramAssembler,this,t))),r}},P.route=P.assembleRoute,q=function(){var t,e,r,n;t={},r={Before:0,After:1};for(e in r)n=r[e],t["insert"+e]=function(t,e){return function(r,n){var o,s,i,u;if(s=this.get(r),o=this.get(n),i=this.indexOf(s),u=this.indexOf(o),0>i)throw new Error("["+S+"] Can't insert "+o+" "+t+" "+s+" because "+s+" does not exist in store");return u>-1&&a.removeAt(this,u),a.insertAt(this,i+e,o),this}}(e.toLowerCase(),n);return t}(),a.extend(S,c.InstanceMembers),S.$=s,S.toString=function(){return"StateRouter"},S.start=function(){return S.notify("debug"),S.notify("start")},S.stop=function(){return S.notify("stop")},S.url=function(t,e){var r;return r=S.history.pushStateBased?"/":"#",r+S.states.fetch(t).route(e)},S.go=function(t,e){return S.navigate(S.url(t,e),!0)},S.navigate=function(t,e){return S.history.navigate(t,e)},S.transition=function(t,e){var r,n,o,a,s,i,u;return o=S.currentState,r=S.currentParams,n=S.currentRoute,i=S.states.fetch(t),a=e||{},s=S.history.route,u=new I({fromState:o,fromParams:r,fromRoute:n,toState:i,toParams:a,toRoute:s}),u.dispatch()},S.controllerLookupNamespace=this,S.controllerLookup=function(t){var e;return e=a.result(S,"controllerLookupNamespace"),e[t+"Controller"]||e[t]||e[t.classCase()+"Controller"]||e[t.classCase()]},S.findController=function(){var t,r,n;return r=arguments[0],n=2<=arguments.length?e.call(arguments,1):[],t=a.isFunction(r)?r.apply(null,n):S.controllerLookup(r),a.isString(t)&&(t=S.controllerLookup(t)),t},h=function(){function t(t){this.constructWith(t)}return t.include(u),t}(),b=function(t){function e(){if(e.__super__.constructor.apply(this,arguments),this.id=a.generateId(),this.handles404=!!this.handles404,this["abstract"]=!!this["abstract"],this.isRoot=!this.base,this["abstract"]&&this.handles404)throw new Error("["+S+"] State can't handle 404 errors and be abstract at the same time");if(this.pattern.regexBased&&!this.ownRouteAssembler)throw new Error("["+S+"] To assemble "+this.name+" state's route from pattern which is based on regex you must define custom assembler")}return r(e,t),e.include(w),e.include(x),e.include(P),e.param("name",{required:!0}),e.param("pattern",{required:!0}),e.param("base"),e.param("404",{as:"handles404"}),e.param("abstract"),e.param("controller",{as:"controllerName"}),e.prototype.toString=function(){return"state "+this.name},e.property("root",function(){var t;for(t=this;;){if(!t.base)break;t=t.base}return t!==this?t:void 0}),e.property("chain",function(){var t,e;for(t=[this],e=this;e=e.base;)t.unshift(e);return t}),e}(h),C=function(t){function e(){e.__super__.constructor.apply(this,arguments),this._byName={}}return r(e,t),e.include(q),e.prototype.length=0,e.prototype.push=function(t){return-1===this.indexOf(t)&&(Array.prototype.push.call(this,t),this._byName[t.name]=t),this},e.prototype.get=function(t){return a.isObject(t)?t:this._byName[t]},e.prototype.fetch=function(t){var e;if(e=this.get(t),!e)throw new Error("["+S+"] State "+t+" does not exist!");return e},e.prototype.findOne=function(t,e){var r,n,o;for(r=0,n=this.length;n>r;r++)if(o=this[r],t.call(e,o))return o},e.prototype.indexOf=function(t){var e,r,n,o,a;for(e=this.get(t),r=n=0,o=this.length;o>n;r=++n)if(a=this[r],a===e)return r;return-1},e.prototype.map=function(t){var e,r;return e=[],r=function(t){var r,n,o,s,i;return o=arguments.length,o>1&&a.isFunction(arguments[1])?(n=arguments[1],i=S.states.get(t)):o>1&&a.isObject(arguments[1])&&(s=arguments[1],r=a.last(e),i=S.createState(t,r,s),o>2&&(n=arguments[2]),S.stateStore.push(i)),n&&(e.push(i),n(),e.pop()),S},t(r)},e}(h),_=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.build=function(t,e,r){var n,o;return e&&(t=e.name+"."+t,n=e.pattern),r[404]&&null==r.pattern&&!r.path&&(r.pattern=".*"),o=function(){if(null!=r.pattern)return g.fromRegexSource(r.pattern,{base:n});if(null!=r.path)return g.fromPath(r.path,{base:n});throw new Error("["+S+"] Neither path nor pattern specified for state "+t)}(),a.extend(r,{name:t,base:e,pattern:o}),new b(r)},e}(h),S.createState=function(t){var e,r,n;return r=arguments.length,r>1&&(e=arguments[1]),a.isPlainObject(e)?(n=e,e=null):(a.isString(e)&&(e=S.states.get(e)),r>2&&(n=arguments[2])),S.stateBuilder.build(t,e,n)},R=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.match=function(t){var e,r;if(r=S.states,e=r.findOne(function(e){return!e["abstract"]&&!e.handles404&&e.pattern.test(t)}),e||(e=r.findOne(function(t){return t.handles404})),!e)throw new Error("["+S+"] None of states matched route '"+t+"' and no 404 state was found");return e},e}(h),g=function(t){function e(){var t,r,n;e.__super__.constructor.apply(this,arguments),(t=null!=(n=this.base)?n.source:void 0)&&(this.source=t+(this.source?"/"+this.source:"")),this.type=null!=this.ownPath?"path":"regex",this.regexBased="regex"===this.type,this.pathBased="path"===this.type,r=S.patternCompiler,this.reRoute=r.compile(this.source,{starts:!0,ends:!0}),this.reRouteIdentity=r.compile(this.source,{starts:!0,ends:!1})}var n;return r(e,t),e.param("base"),e.param("source",{as:"source",required:!0}),e.param("path",{as:"ownPath"}),n=a.extend,e.prototype.test=function(t){return this.reRoute.test(t)},e.prototype.match=function(t){return E.exec(t,this.reRoute)},e.prototype.identity=function(t){return E.exec(t,this.reRouteIdentity)},e.fromPath=function(t,e){var r,o;return r=S.pathDecorator,o=r.preprocessParams(r.escape(t)),this.fromRegexSource(o,n({},e,{path:t}))},e.fromRegexSource=function(t,e){return new this(n({},e,{source:t}))},e}(h),v=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var n;return r(e,t),e.prototype.rsQueryString="(?:\\?(?<query>([\\s\\S]*)))?",e.prototype.reQueryString=E(e.prototype.rsQueryString+"$"),e.prototype.leftBoundary="^",e.prototype.rightBoundary=e.prototype.rsQueryString+"$",n=a.isEnabled,e.prototype.compile=function(t,e){return E(this.bound(t,e))},e.prototype.bound=function(t,e){var r,o,a;return a=n(e,"starts"),o=n(e,"ends"),r=""===t,a&&(t=this.leftBoundary+t,r&&!o&&(t+=this.rsQueryString)),o&&(t+=this.rightBoundary),t},e}(h),y=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.params("paramPreprocessor","reEscape","escapeReplacement"),e.prototype.reEscape=/[\-{}\[\]+?.,\\\^$|#\s]/g,e.prototype.reParam=/(\()?(.)?(\*)?:(\w+)\)?/g,e.prototype.escapeReplacement="\\$&",e.prototype.paramPreprocessor=function(t,e,r,n,o){var a;return a="(?:"+(r||"")+"(?<"+o+">"+(n?"[^?]*?":"[^/?]+")+"))",e?"(?:"+a+")?":a},e.prototype.preprocessParams=function(t){return this.replaceParams(t,this.paramPreprocessor)},e.prototype.replaceParams=function(t,e){return t.replace(this.reParam,e)},e.prototype.escape=function(t){return t.replace(this.reEscape,this.escapeReplacement)},e}(h),S.once("start",function(){return S.on("transitionStart",function(t){return S.dispatchedTransition=t}),S.on("transitionAbort",function(t){return S.dispatchedTransition=null,S.abortedTransition=t}),S.on("transitionSuccess",function(t){return S.succeedTransition=t,S.currentParams=t.params,S.currentRoute=t.route,S.dispatchedTransition=null}),S.on("stateEnterSuccess",function(t){return S.currentState=t,S.notify("stateChange",t)}),S.on("stateLeaveSuccess",function(t){return S.currentState=t.base})}),S.once("debug",function(){return S.on("transitionStart",function(t){return console.debug("["+S+"] Started "+t),console.debug("["+S+"] Parameters",t.params)}),S.on("transitionSuccess",function(t){return console.debug("["+S+"] Succeed "+t)}),S.on("stateEnterStart",function(t){return console.debug("["+S+"] Entering "+t)}),S.on("stateLeaveStart",function(t){return console.debug("["+S+"] Leaving "+t)})}),l=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.dispatch=function(t){var e,r,o,a,s,i,u,c,p,h,l,f,d;if(null!=(f=S.dispatchedTransition)&&f.abort(),S.notify("transitionStart",t),!t.prevented){for(e=S.currentState,r=(null!=e?e.chain:void 0)||[],h=t.state,l=(null!=h?h.chain:void 0)||[],o=[],u=[],a=[],s=0,c=r.length;c>s;s++)d=r[s],n.call(l,d)>=0?this.mustReloadState(d,t)?(u.unshift(d),o.push(d)):a.push(d):u.unshift(d);for(i=0,p=l.length;p>i;i++)d=l[i],n.call(o,d)<0&&n.call(a,d)<0&&o.push(d);for(;d=u.shift();)if(this.leaveState(d,t),t.aborted)return;for(;d=o.shift();)if(this.enterState(d,t),t.aborted)return;S.notify("transitionSuccess",t)}},e.prototype.enterState=function(t,e){var r,n,o,s,i,u;S.notify("stateEnterStart",t,e),n=S.findController(t.controllerName,e.params,e),n&&(u=t.root,i=null!=u?u.__controller:void 0,o=null!=(s=t.base)?s.__controller:void 0,n=a.beforeConstructor(n,function(){return this.rootController=i||void 0,this.parentController=o||void 0}),r=new n(e.params,e),"function"==typeof r.enter&&r.enter(e.toParams,e)),e.aborted||(t.__controller=r,t.__paramsIdentity=t.identityParams(e.route),S.notify("stateEnterSuccess",t,e))},e.prototype.leaveState=function(t,e){var r;S.notify("stateLeaveStart",t,e),r=t.__controller,null!=r&&"function"==typeof r.leave&&r.leave(e.params,e),e.aborted||(delete t.__paramsIdentity,delete t.__controller,S.notify("stateLeaveSuccess",t,e))},e.prototype.mustReloadState=function(t,e){var r,n,o;return r=t.__paramsIdentity,n=t.identityParams(e.route),!1===((null!=(o=S.options)?o.reloadOnQueryChange:void 0)!==!0?a.isEqual(a.omit(r,"query"),a.omit(n,"query")):a.isEqual(r,n))},e}(h),m=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.reArrayIndex=/^[0-9]+$/,e.prototype.refersToRegexMatch=function(t){return this.reArrayIndex.test(t)||"index"===t||"input"===t},e.prototype.refersToQueryString=function(t){return"query"===t},e.prototype.encode=function(t,e){return encodeURIComponent(e)},e.prototype.encodeSplat=function(t,e){return encodeURI(e)},e.prototype.decode=function(t,e){return decodeURIComponent(e)},e}(h),S.on("debug",function(){return S.on("transitionAbort",function(t){return console.debug("["+S+"] Aborted "+t)}),S.on("transitionPrevent",function(t){return console.debug("["+S+"] Prevented "+t)})}),I=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.prevented=!1,this.aborted=!1}return r(e,t),e.param("fromState"),e.param("fromParams"),e.param("fromRoute"),e.param("toState",{alias:"state",required:!0}),e.param("toParams",{alias:"params",required:!0}),e.param("toRoute",{alias:"route",required:!0}),e.prototype.prevent=function(){return this.prevented||S.notify("transitionPrevent",this),this.prevented=!0,this},e.prototype.abort=function(){return this.aborted||S.notify("transitionAbort",this),this.aborted=!0,this},e.prototype.dispatch=function(){return S.dispatcher.dispatch(this)},e.prototype.retry=function(){return this.dispatch()},e.prototype.toString=function(){var t;return t="transition",t+=this.fromState?" "+this.fromState.name:" <initial>",t+=" -> "+this.toState.name},e}(h),S.once("start",function(){return S.on("routeChange",function(t){var e;return e=S.stateMatcher.match(t),S.transition(e,e.params(t),t)})}),S.on("start",function(){return S.history.start()}),S.on("stop",function(){return S.history.stop()}),S.once("debug",function(){return S.once("routeChange",function(t){return console.debug("["+S+"] Started with route '"+t+"'"),S.on("routeChange",function(t){return console.debug("["+S+"] Route changed '"+t+"'")})}),S.on("fragmentUpdate",function(t,e){return console.debug("["+S+"] "+(e?"Replaced hash in history with '"+t+"'":"Set hash to history '"+t+"'"))}),S.on("pathUpdate",function(t,e){return console.debug("["+S+"] "+(e?"Replaced state in history with '"+t+"'":"Pushed state to history '"+t+"'"))})}),f=function(t){function e(){var t,r,n;this.options={},this.options.load=!0,this.options.interval=50,e.__super__.constructor.apply(this,arguments),a.onceMethod(this,"start"),a.bindMethod(this,"check"),this.document="undefined"!=typeof document&&null!==document&&document,this.window="undefined"!=typeof window&&null!==window&&window,this.location=null!=(t=this.window)?t.location:void 0,this.history=null!=(r=this.window)?r.history:void 0,this.supportsPushState=null!=(null!=(n=this.history)?n.pushState:void 0),this.supportsHashChange="onhashchange"in this.window,this.pushStateBased=this.supportsPushState&&this.options.pushState!==!1,this.hashChangeBased=!this.pushStateBased&&this.supportsHashChange&&this.options.hashChange!==!1,this.started=!1}return r(e,t),e.derivePath=function(t){return decodeURI((t.pathname+t.search).replace(/%25/g,"%2525")).replace(/^\/+/,"")},e.deriveFragment=function(t){var e;return((null!=(e=t.href.match(/#(.*)$/))?e[1]:void 0)||"")+t.search},e.normalizeRoute=function(t){var e;return e=n.call(t,"?")>=0?t.replace(/\/+\?/,"?"):t.replace(/\/+$/,""),e.replace(/^(\/|#)+/,"")},e.property("path",function(){return this.constructor.derivePath(this.location)}),e.property("fragment",function(){return this.constructor.deriveFragment(this.location)}),e.property("route",function(){return this.pushStateBased?this.path:this.fragment}),e.prototype.start=function(){return this.ensureNotStarted(),this.pushStateBased?S.$(this.window).on("popstate",this.check):this.hashChangeBased?S.$(this.window).on("hashchange",this.check):this._intervalId=setInterval(this.check,this.options.interval),this.started=!0,this.options.load&&this.load(this.route),this},e.prototype.stop=function(){return this.ensureStarted(),S.$(this.window).off("popstate",this.check),S.$(this.window).off("hashchange",this.check),this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null),this.started=!1,this},e.prototype.check=function(t){return this.ensureStarted()&&this.route!==this.loadedRoute&&this.load(this.route),this},e.prototype.load=function(t){var e;return this.ensureStarted(),e=this.constructor.normalizeRoute(t),t!==e?this.navigate(e,{replace:!0,load:!0}):(this.loadedRoute=t,S.notify("routeChange",t),!0)},e.prototype.navigate=function(t,e){return this.ensureStarted(),t=this.constructor.normalizeRoute(t),t!==this.loadedRoute?(this.loadedRoute=t,e&&e!==!0||(e={load:!!e}),this.pushStateBased?this._updatePath(t,e.replace):this._updateFragment(t,e.replace),!e.load||this.load(t)):!1},e.prototype._updatePath=function(t,e){var r;r=e?"replaceState":"pushState",this.history[r]({},this.document.title,"/"+t),S.notify("pathUpdate",t,e)},e.prototype._updateFragment=function(t,e){var r;t=t.replace(/\?.*$/,""),e?(r=this.location.href.replace(/(javascript:|#).*$/,""),this.location.replace(r+"#"+t)):this.location.hash="#"+t,S.notify("fragmentUpdate",e)},e.prototype.ensureStarted=function(){if(!this.started)throw new Error("["+S+"] History hasn't been started!");return!0},e.prototype.ensureNotStarted=function(){if(this.started)throw new Error("["+S+"] History has already been started!");return!0},e}(h),S.on("start",function(){return S.linksInterceptor.start()}),S.on("stop",function(){return S.linksInterceptor.stop()}),S.reURIScheme=/^(\w+):(?:\/\/)?/,S.matchURIScheme=function(t){var e;return null!=t&&"function"==typeof t.match&&null!=(e=t.match(S.reURIScheme))?e[0]:void 0},d=function(t){function e(){e.__super__.constructor.apply(this,arguments),a.bindMethod(this,"intercept"),this.started=!1}return r(e,t),e.prototype.start=function(){if(this.started)throw new Error("["+S+"] Links interceptor has already been started!");return S.$(document).on("click","a",this.intercept),this.started=!0,this},e.prototype.stop=function(){if(!this.started)throw new Error("["+S+"] Links interceptor hasn't been started!");return S.$(document).off("click","a",this.intercept),this.started=!1,this},e.prototype.intercept=function(t){var e,r,n,o,a;1===t.which&&(e=S.$(t.currentTarget),(r=e.attr("href"))&&(n=null!=(o=e.attr("intercept"))?o:e.data("intercept"),"false"!==n&&null==S.matchURIScheme(r)&&(t.preventDefault(),a=S.history.pushStateBased?f.derivePath(e[0]):f.deriveFragment(e[0]),S.navigate(a,!0))))},e}(h),a.extend(S,{State:b,StateStore:C,StateBuilder:_,StateDefaultParameters:w,StateRouteParameters:x,StateRouteAssemble:P,StateStoreFrameworkFeatures:q,Dispatcher:l,History:f,PathDecorator:y,PatternCompiler:v,StateMatcher:R,Transition:I,Pattern:g,ParamHelper:m,LinksInterceptor:d}),S})}).call(this);