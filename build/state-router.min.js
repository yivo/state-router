(function(){var t={}.hasOwnProperty,e=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};!function(t,e){"function"==typeof define&&define.amd?define(["lodash","jquery","strict-parameters","pub-sub","XRegExp","yess","ize","coffee-concerns"],function(r,o,n,a,s){return t.StateRouter=e(t,r,o,n,a,s)}):"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t,require("lodash"),require("jquery"),require("strict-parameters"),require("pub-sub"),require("XRegExp"),require("yess"),require("ize"),require("coffee-concerns")):t.StateRouter=e(t,t._,t.$,t.StrictParameters,t.PublisherSubscriber,t.XRegExp)}(this,function(r,o,n,a,s,i){var u,l,c,p,h,f,d,m,y,g,S,v,b,P,w,R,C,x,_;return i.XRegExp&&(i=i.XRegExp),g={},b={getDefaultParam:function(t){var e,r;for(e=this;e;){if(r=e.getOwnDefaultParam(t),null!=r)return r;e=e.base}},getOwnDefaultParam:function(t){var e;return e=this.getOwnDefaultParams(),null!=e?e[t]:void 0},getOwnDefaultParams:function(){return this.defaults},hasOwnDefaultParam:function(t){return null!=this.getOwnDefaultParam(t)}},R={extractParams:function(e){var r,o,n,a,s;r=g.paramHelper,o=i.exec(e,this.pattern.pattern),a={__version:r.hashCode(e)};for(n in o)t.call(o,n)&&(s=o[n],r.refersToRegexMatch(n)||(a[n]=null!=s?r.refersToQueryString(n)?s:r.decode(n,s):this.getDefaultParam(n)));return a},extractOwnParams:function(e){var r,o,n,a,s;r=g.paramHelper,o=i.exec(e,this.pattern.startsWithPattern),a={__version:null!=o?r.hashCode(o[0]):void 0,query:this.extractQueryString(e)};for(n in o)t.call(o,n)&&(s=o[n],r.refersToRegexMatch(n)||(a[n]=null!=s?r.decode(n,s):this.getOwnDefaultParam(n)));return a},extractQueryString:function(t){var e;return null!=(e=i.exec(t,y.prototype.reQueryString))?e.query:void 0}},C=function(){var t,e;return t=o.extend,e=o.isFunction,{paramAssembler:function(t,e,r,o,n){var a,s;if(s=null!=(null!=(a=this._assembleParams)?a[n]:void 0)?this._assembleParams[n]:this.getDefaultParam(n),null==s){if(!e)throw"NOT OPTIONAL"+n;return""}return r+(o?encodeURI(s):encodeURIComponent(s))},hasCustomRouteAssembler:function(){return!!this.assembler},getCustomRouteAssembler:function(){return this.assembler},requiresCustomRouteAssembler:function(){return this.pattern.isPatternBased()},assembleRoute:function(r){var o,n;if(this.parent&&(n=this.parent.assembleRoute(r)),this.hasCustomRouteAssembler())o=this.getCustomRouteAssembler(),n=(n?n+"/":"")+(e(o)?o.call(this,t({},this.getOwnDefaultParams(),r),this):o);else{if(this.requiresCustomRouteAssembler())throw"To assemble fragment from pattern which is based on regex you need to define custom assembler";this._assembleParams=r,n=(n?n+"/":"")+this.pattern.path.replace(d.prototype.reParam,this.paramAssembler)}return null!=(null!=r?r.query:void 0)&&(n=n+("?"===r.query[0]?"":"?")+r.query),this._assembleParams=null,n}}}(),S=function(){function t(t){if(e(this,"paramAssembler"),r(this,t),t["abstract"]&&t["default"])throw new Error("State can be either abstract either default")}var e,r;return t.include(b),t.include(R),t.include(C),e=o.bindMethod,r=o.extend,t.prototype.isAbstract=function(){return!!this["abstract"]},t.prototype.isDefault=function(){return!!this["default"]},t.prototype.is404=function(){return!!this[404]},t.prototype.getChain=function(){var t,e;for(t=[this],e=this;e=e.base;)t.unshift(e);return t},t}(),g.loadStateStore=function(){return g.stateStore||(g.stateStore=new P)},P=function(){function t(){this._byName={}}var e;return t.prototype.length=0,e=Array.prototype.push,t.prototype.push=function(t){return e.call(this,t),this._byName[t.name]=t,this},t.prototype.get=function(t){return this._byName[t]},t.prototype.findOne=function(t,e){var r,o,n;for(r=0,o=this.length;o>r;r++)if(n=this[r],t.call(e,n))return n},t}(),g.loadStateBuilder=function(){return g.stateBuilder||(g.stateBuilder=new v)},v=function(){function t(){}var e;return e=o.extend,t.prototype.build=function(t,r,o){var n,a;return r&&(t=r.name+"."+t),a=function(){if(null!=o.path)return m.fromPath(o.path,{base:null!=r?r.pattern:void 0,name:t});if(null!=o.pattern)return m.fromRegex(o.pattern,{base:null!=r?r.pattern:void 0,name:t});if(o[404])return m.fromRegex(".*",{base:null!=r?r.pattern:void 0,name:t});throw 1}(),e(o,{name:t,base:r,pattern:a}),n=new S(o),r&&(r.subordinates||(r.subordinates=[])).push(n),console.log("----"),n},t}(),g.loadStateMatcher=function(){return g.stateMatcher||(g.stateMatcher=new w)},w=function(){function t(){}return t.prototype.match=function(t,e){var r,o;if(console.debug("MATCH '"+t+"'"),o=g.stateStore,r=o.findOne(function(e){return!e.isAbstract()&&!e.is404()&&e.pattern.pattern.test(t)}),r||(r=o.findOne(function(t){return t.isDefault()})),!r)throw"NO STATE!!";return r},t}(),m=function(){function t(t){var e;this.mergeParams(t),e=g.patternCompiler,this.startsWithPattern=e.compile(this.source,{starts:!0,ends:!1}),this.pattern=e.compile(this.source,{starts:!0,ends:!0}),console.log(t.name+", source: "+this.source+", st: "+this.startsWithPattern+", p: "+this.pattern)}return t.include(a),t.params("source","type",{required:!0}),t.params("base","path"),t.params("name"),t.prototype.isPatternBased=function(){return"regex"===this.type},t.fromPath=function(t,e){var r,o,n;return o=g.pathDecorator,t=o.strip(t),n=o.preprocess(o.escape(t)),(r=null!=e?e.base:void 0)&&r.source&&(n=r.source+(n?"/"+n:"")),new this({source:n,path:t,base:r,type:"path",name:null!=e?e.name:void 0})},t.fromRegex=function(t,e){var r;return(r=null!=e?e.base:void 0)&&r.source&&(t=r.source+(t?"/"+t:"")),new this({source:t,base:r,type:"regex",name:null!=e?e.name:void 0})},t}(),g.loadPatternCompiler=function(){return g.patternCompiler||(g.patternCompiler=new y)},y=function(){function t(){}var e;return t.prototype.rsQueryString="(?:\\?(?<query>([\\s\\S]*)))?",t.prototype.reQueryString=i(t.prototype.rsQueryString+"$"),t.prototype.leftBoundary="^",t.prototype.rightBoundary=t.prototype.rsQueryString+"$",e=o.isEnabled,t.prototype.compile=function(t,e){return i(this.bound(t,e))},t.prototype.bound=function(t,r){var o,n,a;return a=e(r,"starts"),n=e(r,"ends"),o=""===t,a&&(t=this.leftBoundary+t,o&&!n&&(t+=this.rsQueryString)),n&&(t+=this.rightBoundary),t},t}(),g.loadPathDecorator=function(){return g.pathDecorator||(g.pathDecorator=new d)},d=function(){function t(){}return t.prototype.reEscape=/[\-{}\[\]+?.,\\\^$|#\s]/g,t.prototype.reLeadingTrash=/^[#\/\s]+/,t.prototype.reTrailingTrash=/[\/\s]+$/,t.prototype.escapeReplacement="\\$&",t.prototype.reParam=/(\()?(.)?(\*)?:(\w+)\)?/g,t.prototype.paramPreprocessor=function(t,e,r,o,n){var a;return a="(?:"+(r||"")+"(?<"+n+">"+(o?"[^?]*?":"[^/?]+")+"))",e?"(?:"+a+")?":a},t.prototype.preprocess=function(t){return t.replace(this.reParam,this.paramPreprocessor)},t.prototype.escape=function(t){return t.replace(this.reEscape,this.escapeReplacement)},t.prototype.strip=function(t){return t.replace(this.reLeadingTrash,"").replace(this.reTrailingTrash,"")},t}(),g.loadDispatcher=function(){return g.dispatcher||(g.dispatcher=new l)},l=function(){function t(){this._paramsStore={}}return t.prototype.dispatch=function(t,r){var n,a,s,i,u,l,c,p,h,f,d,m,y,S,v,b,P,w,R;for(v=t.toState,a=t.fromState,b=(null!=v?v.getChain():void 0)||[],s=(null!=a?a.getChain():void 0)||[],w=t.route,i=[],h=[],u=[],l=0,f=s.length;f>l;l++)R=s[l],e.call(b,R)>=0?this.needToReloadState(R,w)?(h.unshift(R),i.push(R)):u.push(R):h.unshift(R);for(c=0,d=b.length;d>c;c++)R=b[c],e.call(i,R)<0&&e.call(u,R)<0&&i.push(R);for(p=0,m=h.length;m>p;p++)R=h[p],console.warn("Exit "+R.name),this._removeParams(R),null!=(P=R.runningCtrl)&&"function"==typeof P.destroy&&P.destroy(),R.runningCtrl=null;for(S=0,y=i.length;y>S;S++)R=i[S],console.warn("Enter "+R.name),(n=g.controllerStore.getClass(R.controller))&&(n=o.beforeConstructor(n,function(){return console.log("I AM CTRL")}),R.runningCtrl=new n),this._storeParams(R,R.extractOwnParams(w));return v&&console.log("Final params",v.extractParams(w)),!0},t.prototype.needToReloadState=function(t,e){var r,o;return r=this._getParams(t),o=t.extractOwnParams(e),console.debug("compare "+t.name,r,o),(null!=r?r.__version:void 0)!==(null!=o?o.__version:void 0)},t.prototype._storeParams=function(t,e){return this._paramsStore[t.name]=e},t.prototype._removeParams=function(t){return this._paramsStore[t.name]=void 0},t.prototype._getParams=function(t){var e;return null!=(e=this._paramsStore)?e[t.name]:void 0},t}(),g.loadParamHelper=function(){return g.paramHelper||(g.paramHelper=new f)},f=function(){function t(){}return t.prototype.reDigitsOnly=/^[0-9]+$/,t.prototype.refersToRegexMatch=function(t){return this.reDigitsOnly.test(t)||"index"===t||"input"===t},t.prototype.refersToQueryString=function(t){return"query"===t},t.prototype.decode=function(t,e){return decodeURIComponent(e)},t.prototype.hashCode=function(t){var e,r,o,n,a;for(r=0,o=n=0,a=t.length;a>=0?a>n:n>a;o=a>=0?++n:--n)e=t.charCodeAt(o),r=(r<<5)-r+e,r&=r;return r},t}(),g.$=n,_=o.last,g.controller=function(t,e){return g.loadControllerStore(),g.controllerStore.registerClass(t,e)},g.state=function(){var t;return t=[],function(e,r,o){var n,a;return a=_(t),n=g.stateBuilder.build(e,a,r),g.stateStore.push(n),o&&(t.push(n),o(),t.pop()),g}}(),g.map=function(t){return g.loadStateStore(),g.loadStateBuilder(),g.loadStateMatcher(),g.loadPathDecorator(),g.loadPatternCompiler(),g.loadParamHelper(),t.call(this,g.state)},g.dispatch=function(t){return g.loadDispatcher(),g.dispatcher.dispatch(t)},g.urlTo=function(t,e){return o.isString(t)&&(t=g.stateStore.get(t)),g.history.pushStateBased?g.history.root+"/"+t.assembleRoute(e):"#"+g.history.root+"/"+t.assembleRoute(e)},g.loadControllerStore=function(){return g.controllerStore||(g.controllerStore=new u)},u=function(){function t(){this._classByName={},this._instanceByName={}}return t.prototype.getClass=function(t){return this._classByName[t]},t.prototype.getInstance=function(t){return this._instanceByName[t]},t.prototype.registerClass=function(t,e){return this._classByName[t]=e},t.prototype.registerInstance=function(t,e){return this._instanceByName[t]=e},t}(),x=function(){function t(t){this.mergeParams(t)}return t.include(a),t.param("fromState"),t.params("toState","route",{required:!1}),t.prototype.retry=function(){},t.prototype.prevent=function(){},t.prototype.isPrevented=function(){},t}(),g.loadHistory=function(){return g.history||(g.history=new c)},c=function(){function t(t){s(this,"start"),r(this,"checkRoute"),"undefined"!=typeof window&&null!==window&&(this.location=window.location,this.history=window.history)}var r,n,a,s;return t.prototype.reFragment=/#(.*)$/,t.prototype.reLeadingSlashes=/^\/+/,t.prototype.reTrailingSlashes=/\/+$/,t.prototype.reSurroundingSlashes=/^\/+|\/+$/g,t.prototype.reLeadingHash=/^#/,t.prototype.reSurroundingWhitespace=/^\s+|\s+$/g,t.prototype.interval=50,n=o.extend,r=o.bindMethod,s=o.onceMethod,a=o.isEnabled,t.prototype.start=function(t){var e;return this.options=n({root:"/"},t),this.options.root=this.options.root.replace(this.reSurroundingSlashes,""),this.root=this.options.root,this.supportsPushState=null!=(null!=(e=this.history)?e.pushState:void 0),this.pushStateBased=this.supportsPushState&&null!=this.options.pushState,this.hashChangeBased=!this.supportsPushState||!this.pushStateBased&&this.options.hashChange!==!1,this.route=this.getRoute(),this.pushStateBased?g.$(window).on("popstate",this.checkRoute):"onhashchange"in window?g.$(window).on("hashchange",this.checkRoute):setInterval(this.checkRoute,this.interval),this.options.silent?void 0:this.loadRoute(this.getRoute())},t.prototype.checkRoute=function(t){var e;return e=this.getRoute(),e!==this.route?this.loadRoute(e):void 0},t.prototype.loadRoute=function(t){var e,r,o,n;return e=this.removeRouteAmbiguity(t),t!==e&&(this.navigate(e,{replace:!0,trigger:!1}),t=e),this.route=t,r=g.currentState,o=0!==t.indexOf(this.root)?g.stateStore.findOne(function(t){return t.is404()}):(t=t.slice(this.root.length).replace(this.reLeadingSlashes,""),g.stateMatcher.match(t)),g.currentState=o,n=new x({fromState:r,toState:o,route:t}),g.dispatch(n)},t.prototype.navigate=function(t,e){var r,o;return t=this.removeRouteAmbiguity(t),this.route!==t?(e&&e!==!0||(e={trigger:!!e}),o=!e.trigger||this.loadRoute(t),o&&(this.route=t,this.pushStateBased?(r=e.replace?"replaceState":"pushState",this.history[r]({},document.title,"/"+t)):this._updateHash(this.location,t,e.replace)),o):void 0},t.prototype.getPath=function(){return decodeURI(this.location.pathname+this.location.search)},t.prototype.getFragment=function(){var t;return((null!=(t=this.location.href.match(this.reFragment))?t[1]:void 0)||"")+this.location.search},t.prototype.getRoute=function(t){return this.pushStateBased?this.getPath(t):this.getFragment(t)},t.prototype._updateHash=function(t,e,r){var o;e=e.replace(/\?.*$/,""),r?(o=t.href.replace(/#.*$/,""),t.replace(o+"#"+e)):t.hash="#"+e},t.prototype.removeRouteAmbiguity=function(t){return t=e.call(t,"?")>=0?t.replace(/\/+\?/,"?"):t.replace(this.reTrailingSlashes,""),t.replace(this.reLeadingSlashes,"")},t}(),p=function(){function t(){g.$(document).on("click","a",o.bind(this["int"],this))}return t.prototype.reUriAnchor=/^#/,t.prototype.reUriScheme=/^(\w+):(?:\/\/)?/,t.prototype["int"]=function(t){var e,r,o,n;if(1===t.which&&(e=g.$(t.currentTarget),(r=e.attr("href"))&&(o=this._getAttr(e,"intercept"),"false"!==o&&!this.reUriAnchor.test(r)&&!this.reUriScheme.test(r))))return t.preventDefault(),n=e[0].pathname.replace(/^\//,""),g.history.navigate(n,!0)},t.prototype._getAttr=function(t,e){var r;return null!=(r=t.attr(e))?r:t.data(e)},t}(),new p,g.map(function(t){return t("error",{path:"error","default":!0}),t("404",{404:!0,controller:"404"}),t("public",{path:"",controller:"index","abstract":!0},function(){return t("model",{path:":modelName",controller:"modelController","abstract":!0},function(){return t("list",{path:"",controller:"modelListController"}),t("form",{path:":id/edit",controller:"modelFormController"})}),t("index",{path:""}),t("users",{path:"users",controller:"users"}),t("profile",{path:"profile",controller:"profile","abstract":!0},function(){return t("settings",{path:"settings/:section",controller:"profileSettings",defaults:{section:"account"}},function(){return t("action",{path:":action"})}),t("chat",{pattern:"chats?",controller:"profileChat",assembler:"chat"},function(){return t("search",{pattern:"search(?:/(?<q>[^/?]+))?",controller:"profileChatSearch",defaults:{q:"empty str"},assembler:function(t){return t.q?"search/"+t.q:"search"}})})})})}),g.controller("modelController",function(){return console.log("model base ctrl",this)}),g.controller("modelFormController",function(){return console.log("model form ctrl",this)}),g.controller("modelListController",h=function(){function t(){this.out()}return t.prototype.destroy=function(){return console.log("model list exit")},t.prototype.out=function(){return console.log("model list ctrl",this)},t}()),g.controller("404",function(){return document.documentElement.innerHTML="<h1>404</h1>",this.destroy=function(){var t;return alert("404 destroy"),t=document.getElementsByTagName("h1")[0],t.parentNode.removeChild(t)}}),g.loadHistory(),g.history.start({root:"root"}),o.extend(g,{State:S,StateList:P,StateBuilder:v,StateDefaultsAccess:b,StateParametersExtract:R,StateRouteAssemble:C,Dispatcher:l,ControllerStore:u,History:c,PathDecorator:d,PatternCompiler:y,StateMatcher:w,Transition:x,Pattern:m})})}).call(this);